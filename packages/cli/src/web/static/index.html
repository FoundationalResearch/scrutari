<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scrutari</title>
<style>
/* ── CSS Reset & Theme ────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #1a1b26;
  --bg-surface: #24283b;
  --bg-hover: #292e42;
  --text: #c0caf5;
  --text-dim: #565f89;
  --blue: #7aa2f7;
  --cyan: #7dcfff;
  --green: #9ece6a;
  --yellow: #e0af68;
  --red: #f7768e;
  --border: #3b4261;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', 'SF Mono', monospace;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 14px;
  line-height: 1.6;
  overflow: hidden;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 16px;
}

/* ── Scrollable message area ──────────────────────────────── */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 0;
  scroll-behavior: smooth;
}

#messages::-webkit-scrollbar { width: 6px; }
#messages::-webkit-scrollbar-track { background: transparent; }
#messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ── Welcome Banner ───────────────────────────────────────── */
.welcome-banner {
  border: 1px solid var(--blue);
  border-radius: 8px;
  padding: 20px 24px;
  margin-bottom: 16px;
}

.welcome-banner .banner-title {
  color: var(--blue);
  font-weight: bold;
  margin-bottom: 16px;
  font-size: 13px;
}

.welcome-banner .banner-content {
  display: flex;
  gap: 32px;
}

.welcome-banner .banner-left {
  flex-shrink: 0;
}

.welcome-banner .banner-greeting {
  font-weight: bold;
  margin-bottom: 8px;
}

.welcome-banner .owl {
  color: var(--blue);
  white-space: pre;
  font-size: 13px;
  line-height: 1.3;
  margin-bottom: 8px;
}

.welcome-banner .banner-info {
  color: var(--text-dim);
  font-size: 12px;
}

.welcome-banner .banner-right {
  border-left: 1px solid var(--blue);
  padding-left: 24px;
  flex: 1;
  min-width: 0;
}

.welcome-banner .banner-section-title {
  color: var(--blue);
  font-weight: bold;
  font-size: 13px;
  margin-bottom: 4px;
}

.welcome-banner .tip {
  font-size: 13px;
  margin-bottom: 2px;
}

.welcome-banner .tip .tip-cmd {
  color: var(--text-dim);
}

.welcome-banner .sessions-section {
  margin-top: 12px;
}

.welcome-banner .session-item {
  font-size: 12px;
  color: var(--text-dim);
  cursor: pointer;
  padding: 2px 0;
}

.welcome-banner .session-item:hover {
  color: var(--blue);
}

/* ── Messages ─────────────────────────────────────────────── */
.message {
  margin-bottom: 16px;
  animation: fadeIn 0.15s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.user .message-content {
  color: var(--text);
}

.message.user .prompt-icon {
  color: var(--blue);
  font-weight: bold;
  margin-right: 8px;
}

.message.assistant .message-content {
  padding-left: 4px;
}

.message.system .message-content {
  color: var(--text-dim);
  font-style: italic;
  padding-left: 4px;
}

/* ── Markdown content ─────────────────────────────────────── */
.markdown-content h1, .markdown-content h2, .markdown-content h3 {
  color: var(--blue);
  margin: 12px 0 6px 0;
}
.markdown-content h1 { font-size: 18px; }
.markdown-content h2 { font-size: 16px; }
.markdown-content h3 { font-size: 14px; }

.markdown-content p { margin: 6px 0; }

.markdown-content code {
  background: var(--bg-surface);
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 13px;
}

.markdown-content pre {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
  overflow-x: auto;
  margin: 8px 0;
}

.markdown-content pre code {
  background: none;
  padding: 0;
}

.markdown-content ul, .markdown-content ol {
  padding-left: 20px;
  margin: 6px 0;
}

.markdown-content table {
  border-collapse: collapse;
  margin: 8px 0;
  width: 100%;
}

.markdown-content th, .markdown-content td {
  border: 1px solid var(--border);
  padding: 6px 10px;
  text-align: left;
}

.markdown-content th {
  background: var(--bg-surface);
  color: var(--blue);
}

.markdown-content blockquote {
  border-left: 3px solid var(--blue);
  padding-left: 12px;
  color: var(--text-dim);
  margin: 8px 0;
}

.markdown-content a {
  color: var(--blue);
  text-decoration: none;
}

.markdown-content a:hover {
  text-decoration: underline;
}

.markdown-content strong { color: var(--text); }
.markdown-content em { color: var(--text-dim); }

/* ── Streaming cursor ─────────────────────────────────────── */
.streaming-cursor {
  display: inline-block;
  background: var(--blue);
  color: var(--bg);
  animation: blink 0.8s step-end infinite;
  width: 8px;
  height: 16px;
  vertical-align: text-bottom;
}

@keyframes blink {
  50% { opacity: 0; }
}

/* ── Thinking blocks ──────────────────────────────────────── */
.thinking-block {
  margin: 6px 0;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}

.thinking-block summary {
  cursor: pointer;
  padding: 6px 10px;
  color: var(--text-dim);
  font-size: 12px;
  background: var(--bg-surface);
  user-select: none;
  list-style: none;
}

.thinking-block summary::before {
  content: '▸ ';
}

.thinking-block[open] summary::before {
  content: '▾ ';
}

.thinking-block .thinking-content {
  padding: 8px 10px;
  font-size: 12px;
  color: var(--text-dim);
  white-space: pre-wrap;
  max-height: 300px;
  overflow-y: auto;
}

.thinking-block.streaming .thinking-preview {
  padding: 8px 10px;
  font-size: 12px;
  color: var(--text-dim);
  white-space: pre-wrap;
}

/* ── Tool calls ───────────────────────────────────────────── */
.tool-call {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 10px;
  margin: 4px 0;
  font-size: 12px;
  color: var(--text-dim);
  background: var(--bg-surface);
  border-radius: 4px;
  border: 1px solid var(--border);
}

.tool-call .tool-icon {
  flex-shrink: 0;
  width: 14px;
  text-align: center;
}

.tool-call .tool-icon.running { color: var(--blue); }
.tool-call .tool-icon.done { color: var(--green); }
.tool-call .tool-icon.error { color: var(--red); }

.tool-call .tool-name {
  color: var(--cyan);
}

.tool-call .tool-duration {
  color: var(--text-dim);
  font-size: 11px;
  margin-left: auto;
}

/* ── Pipeline progress ────────────────────────────────────── */
.pipeline {
  border: 1px solid var(--border);
  border-radius: 6px;
  margin: 8px 0;
  overflow: hidden;
}

.pipeline-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.pipeline-header .pipeline-title {
  color: var(--blue);
  font-weight: bold;
}

.pipeline-header .pipeline-cost {
  font-size: 12px;
}

.pipeline-stage {
  padding: 6px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.pipeline-stage:last-child {
  border-bottom: none;
}

.pipeline-stage .stage-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pipeline-stage .stage-icon {
  flex-shrink: 0;
  width: 16px;
  text-align: center;
}

.pipeline-stage .stage-icon.pending { color: var(--text-dim); }
.pipeline-stage .stage-icon.running { color: var(--blue); }
.pipeline-stage .stage-icon.done { color: var(--green); }
.pipeline-stage .stage-icon.error { color: var(--red); }

.pipeline-stage .stage-name {
  flex: 1;
}

.pipeline-stage .stage-meta {
  font-size: 11px;
  color: var(--text-dim);
  display: flex;
  gap: 12px;
}

.pipeline-stage-details {
  margin-top: 4px;
}

.pipeline-stage-details summary {
  cursor: pointer;
  color: var(--text-dim);
  font-size: 11px;
  user-select: none;
  list-style: none;
}

.pipeline-stage-details summary::before { content: '▸ '; }
.pipeline-stage-details[open] summary::before { content: '▾ '; }

.pipeline-stage-details .stage-detail-content {
  padding: 4px 0 4px 20px;
  font-size: 11px;
  color: var(--text-dim);
  white-space: pre-wrap;
  max-height: 200px;
  overflow-y: auto;
}

/* ── Approval modal ───────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: fadeIn 0.15s ease-out;
}

.modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
}

.modal h3 {
  color: var(--blue);
  margin-bottom: 12px;
}

.modal p {
  margin-bottom: 12px;
  font-size: 13px;
}

.modal .modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 16px;
}

.modal .modal-actions button {
  padding: 8px 20px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s;
}

.modal .modal-actions button:hover {
  background: var(--bg-hover);
}

.modal .modal-actions button.primary {
  background: var(--blue);
  color: var(--bg);
  border-color: var(--blue);
}

.modal .modal-actions button.primary:hover {
  opacity: 0.9;
}

.modal .modal-actions button.danger {
  border-color: var(--red);
  color: var(--red);
}

/* ── Input area ───────────────────────────────────────────── */
#input-area {
  border-top: 1px solid var(--border);
  padding: 12px 0;
  flex-shrink: 0;
}

#input-area .status-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 0 8px 0;
  font-size: 11px;
  color: var(--text-dim);
}

#input-area .mode-badges {
  display: flex;
  gap: 6px;
}

.mode-badge {
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
  opacity: 0.4;
  transition: opacity 0.15s;
}

.mode-badge.active { opacity: 1; }
.mode-badge.plan { background: var(--yellow); color: var(--bg); }
.mode-badge.dry-run { background: var(--cyan); color: var(--bg); }
.mode-badge.read-only { background: var(--green); color: var(--bg); }

.cost-display {
  font-size: 11px;
}

.cost-display.green { color: var(--green); }
.cost-display.yellow { color: var(--yellow); }
.cost-display.red { color: var(--red); }

#input-area .input-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

#input-area .prompt-symbol {
  color: var(--blue);
  font-weight: bold;
  font-size: 16px;
  flex-shrink: 0;
}

#input-area input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 14px;
  outline: none;
  caret-color: var(--blue);
}

#input-area input::placeholder {
  color: var(--text-dim);
}

#input-area input:disabled {
  opacity: 0.5;
}

/* ── Autocomplete ─────────────────────────────────────────── */
.autocomplete {
  position: relative;
}

.autocomplete-menu {
  position: absolute;
  bottom: 100%;
  left: 28px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 4px 0;
  margin-bottom: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
  min-width: 280px;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
}

.autocomplete-item {
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  gap: 12px;
}

.autocomplete-item:hover, .autocomplete-item.selected {
  background: var(--bg-hover);
}

.autocomplete-item .cmd {
  color: var(--blue);
  flex-shrink: 0;
}

.autocomplete-item .desc {
  color: var(--text-dim);
  font-size: 12px;
}

/* ── Connection status ────────────────────────────────────── */
.connection-status {
  position: fixed;
  top: 8px;
  right: 16px;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 11px;
  z-index: 200;
}

.connection-status.connected {
  background: var(--green);
  color: var(--bg);
}

.connection-status.disconnected {
  background: var(--red);
  color: var(--bg);
}

.connection-status.connecting {
  background: var(--yellow);
  color: var(--bg);
}

/* ── Utility ──────────────────────────────────────────────── */
.hidden { display: none !important; }

</style>
</head>
<body>

<div id="app">
  <div id="messages"></div>
  <div id="input-area">
    <div class="status-bar">
      <div class="mode-badges">
        <span class="mode-badge plan" id="badge-plan" title="Toggle plan mode">PLAN</span>
        <span class="mode-badge dry-run" id="badge-dry-run" title="Toggle dry-run mode">DRY-RUN</span>
        <span class="mode-badge read-only" id="badge-read-only" title="Toggle read-only mode">READ-ONLY</span>
      </div>
      <span class="cost-display green" id="cost-display"></span>
    </div>
    <div class="autocomplete">
      <div class="autocomplete-menu hidden" id="autocomplete-menu"></div>
      <div class="input-row">
        <span class="prompt-symbol">&rsaquo;</span>
        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" spellcheck="false" />
      </div>
    </div>
  </div>
</div>
<div class="connection-status connecting" id="connection-status">Connecting...</div>
<div id="modal-container"></div>

<script>
// ── Minimal marked.js inline (lightweight markdown parser) ──────────
// Using a simple custom parser to avoid bundling 40KB library
const md = (() => {
  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function parseInline(text) {
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    text = text.replace(/_(.+?)_/g, '<em>$1</em>');
    // Code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Links
    text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    return text;
  }

  function parse(src) {
    if (!src) return '';
    const lines = src.split('\n');
    let html = '';
    let i = 0;
    let inList = false;
    let listType = '';

    while (i < lines.length) {
      const line = lines[i];

      // Code block
      if (line.startsWith('```')) {
        const lang = line.slice(3).trim();
        let code = '';
        i++;
        while (i < lines.length && !lines[i].startsWith('```')) {
          code += (code ? '\n' : '') + lines[i];
          i++;
        }
        i++; // skip closing ```
        if (inList) { html += '</'+listType+'>'; inList = false; }
        html += '<pre><code' + (lang ? ' class="language-'+escapeHtml(lang)+'"' : '') + '>' + escapeHtml(code) + '</code></pre>';
        continue;
      }

      // Close list if needed
      if (inList && !/^(\s*[-*+]|\s*\d+\.)/.test(line) && line.trim() !== '') {
        html += '</' + listType + '>';
        inList = false;
      }

      // Headers
      const hMatch = line.match(/^(#{1,6})\s+(.+)/);
      if (hMatch) {
        const level = hMatch[1].length;
        html += '<h'+level+'>' + parseInline(hMatch[2]) + '</h'+level+'>';
        i++; continue;
      }

      // Horizontal rule
      if (/^(-{3,}|\*{3,}|_{3,})$/.test(line.trim())) {
        html += '<hr>';
        i++; continue;
      }

      // Blockquote
      if (line.startsWith('>')) {
        let quote = '';
        while (i < lines.length && lines[i].startsWith('>')) {
          quote += (quote ? '\n' : '') + lines[i].replace(/^>\s?/, '');
          i++;
        }
        html += '<blockquote>' + parse(quote) + '</blockquote>';
        continue;
      }

      // Unordered list
      const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)/);
      if (ulMatch) {
        if (!inList || listType !== 'ul') {
          if (inList) html += '</' + listType + '>';
          html += '<ul>';
          inList = true;
          listType = 'ul';
        }
        html += '<li>' + parseInline(ulMatch[2]) + '</li>';
        i++; continue;
      }

      // Ordered list
      const olMatch = line.match(/^(\s*)\d+\.\s+(.+)/);
      if (olMatch) {
        if (!inList || listType !== 'ol') {
          if (inList) html += '</' + listType + '>';
          html += '<ol>';
          inList = true;
          listType = 'ol';
        }
        html += '<li>' + parseInline(olMatch[2]) + '</li>';
        i++; continue;
      }

      // Table
      if (line.includes('|') && i + 1 < lines.length && /^\s*\|?\s*[-:]+/.test(lines[i+1])) {
        const headers = line.split('|').map(c => c.trim()).filter(Boolean);
        i += 2; // skip header and separator
        let tableHtml = '<table><thead><tr>';
        headers.forEach(h => { tableHtml += '<th>' + parseInline(h) + '</th>'; });
        tableHtml += '</tr></thead><tbody>';
        while (i < lines.length && lines[i].includes('|')) {
          const cells = lines[i].split('|').map(c => c.trim()).filter(Boolean);
          tableHtml += '<tr>';
          cells.forEach(c => { tableHtml += '<td>' + parseInline(c) + '</td>'; });
          tableHtml += '</tr>';
          i++;
        }
        tableHtml += '</tbody></table>';
        html += tableHtml;
        continue;
      }

      // Paragraph
      if (line.trim() === '') {
        i++; continue;
      }

      html += '<p>' + parseInline(line) + '</p>';
      i++;
    }

    if (inList) html += '</' + listType + '>';
    return html;
  }

  return { parse };
})();

// ── App State ────────────────────────────────────────────────────────
const state = {
  ws: null,
  connected: false,
  isProcessing: false,
  modes: { plan: false, 'dry-run': false, 'read-only': false },
  sessionCostUsd: 0,
  budgetUsd: 5,
  skills: [],
  recentSessions: [],
  // Streaming state
  currentAssistantId: null,
  streamingText: '',
  streamingThinking: '',
  thinkingComplete: false,
  // Autocomplete
  autocompleteIndex: -1,
  autocompleteVisible: false,
};

// ── Slash commands ───────────────────────────────────────────────────
const SLASH_COMMANDS = [
  { cmd: '/plan', desc: 'Toggle plan mode' },
  { cmd: '/dry-run', desc: 'Toggle dry-run mode' },
  { cmd: '/read-only', desc: 'Toggle read-only mode' },
  { cmd: '/compact', desc: 'Compact context window' },
  { cmd: '/tools', desc: 'Show configured tools' },
  { cmd: '/mcp', desc: 'Show MCP server status' },
  { cmd: '/skills', desc: 'Browse skills' },
  { cmd: '/help', desc: 'Show available commands' },
];

// ── Spinner frames ───────────────────────────────────────────────────
const SPINNER_FRAMES = ['⠋','⠙','⠹','⠸','⠼','⠴','⠦','⠧','⠇','⠏'];
let spinnerFrame = 0;
setInterval(() => { spinnerFrame = (spinnerFrame + 1) % SPINNER_FRAMES.length; updateSpinners(); }, 80);

function updateSpinners() {
  document.querySelectorAll('.tool-icon.running, .stage-icon.running').forEach(el => {
    el.textContent = SPINNER_FRAMES[spinnerFrame];
  });
}

// ── DOM references ───────────────────────────────────────────────────
const $messages = document.getElementById('messages');
const $input = document.getElementById('chat-input');
const $costDisplay = document.getElementById('cost-display');
const $connStatus = document.getElementById('connection-status');
const $autocompleteMenu = document.getElementById('autocomplete-menu');
const $modalContainer = document.getElementById('modal-container');

// ── WebSocket ────────────────────────────────────────────────────────
let reconnectDelay = 1000;

function connect() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${protocol}//${location.host}/ws`);
  state.ws = ws;

  setConnectionStatus('connecting');

  ws.onopen = () => {
    state.connected = true;
    reconnectDelay = 1000;
    setConnectionStatus('connected');
    setTimeout(() => {
      $connStatus.classList.add('hidden');
    }, 2000);
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleServerMessage(msg);
    } catch (e) {
      console.error('Failed to parse message:', e);
    }
  };

  ws.onclose = () => {
    state.connected = false;
    setConnectionStatus('disconnected');
    setTimeout(() => {
      reconnectDelay = Math.min(reconnectDelay * 2, 10000);
      connect();
    }, reconnectDelay);
  };

  ws.onerror = () => {
    ws.close();
  };
}

function send(msg) {
  if (state.ws && state.ws.readyState === WebSocket.OPEN) {
    state.ws.send(JSON.stringify(msg));
  }
}

function setConnectionStatus(status) {
  $connStatus.className = 'connection-status ' + status;
  $connStatus.textContent = status === 'connected' ? 'Connected' : status === 'connecting' ? 'Connecting...' : 'Disconnected — reconnecting...';
  $connStatus.classList.remove('hidden');
}

// ── Message handlers ─────────────────────────────────────────────────
function handleServerMessage(msg) {
  switch (msg.type) {
    case 'init':
      handleInit(msg);
      break;
    case 'user_message':
      appendUserMessage(msg.id, msg.text);
      break;
    case 'assistant_start':
      startAssistantMessage(msg.id);
      break;
    case 'text_delta':
      appendTextDelta(msg.delta);
      break;
    case 'reasoning_delta':
      appendReasoningDelta(msg.delta);
      break;
    case 'tool_call_start':
      appendToolCallStart(msg.toolCall);
      break;
    case 'tool_call_complete':
      completeToolCall(msg.id, msg.result);
      break;
    case 'pipeline_event':
      updatePipeline(msg.event, msg.pipelineState);
      break;
    case 'assistant_complete':
      completeAssistantMessage(msg);
      break;
    case 'approval_required':
      showApprovalModal(msg.estimate);
      break;
    case 'tool_permission_required':
      showPermissionModal(msg.toolName, msg.args);
      break;
    case 'cost_update':
      updateCost(msg.sessionCostUsd, msg.budgetUsd);
      break;
    case 'processing':
      setProcessing(msg.isProcessing);
      break;
    case 'mode_changed':
      state.modes[msg.mode] = msg.enabled;
      updateModeBadges();
      break;
    case 'sessions_list':
      // Could display in a modal; for now just update state
      state.recentSessions = msg.sessions;
      break;
    case 'session_resumed':
      handleSessionResumed(msg);
      break;
    case 'system_message':
      appendSystemMessage(msg.text);
      break;
    case 'error':
      appendSystemMessage('Error: ' + msg.message);
      break;
  }
}

function handleInit(msg) {
  state.skills = msg.skills;
  state.modes = { plan: msg.modes.plan, 'dry-run': msg.modes.dryRun, 'read-only': msg.modes.readOnly };
  state.recentSessions = msg.recentSessions;
  updateModeBadges();
  renderWelcomeBanner(msg);
}

function handleSessionResumed(msg) {
  $messages.innerHTML = '';
  msg.messages.forEach(m => {
    if (m.role === 'user') {
      appendUserMessage(m.id, m.content);
    } else if (m.role === 'assistant') {
      appendRestoredAssistantMessage(m);
    } else if (m.role === 'system') {
      appendSystemMessage(m.content);
    }
  });
  updateCost(msg.totalCostUsd, state.budgetUsd);
  scrollToBottom();
}

// ── Render functions ─────────────────────────────────────────────────

function renderWelcomeBanner(init) {
  const sessionsHtml = init.recentSessions.length === 0
    ? '<div style="color: var(--text-dim); font-size: 12px;">No recent sessions</div>'
    : init.recentSessions.slice(0, 3).map(s => {
        const title = s.title.length > 30 ? s.title.slice(0, 27) + '...' : s.title;
        const ago = formatTimeAgo(s.updatedAt);
        return `<div class="session-item" data-session-id="${escAttr(s.id)}">${escHtml(title)} <span style="color: var(--text-dim)">${ago}</span></div>`;
      }).join('');

  const shortModelName = shortModel(init.model);

  const html = `<div class="welcome-banner">
    <div class="banner-title">── scrutari v${escHtml(init.version)} ──</div>
    <div class="banner-content">
      <div class="banner-left">
        <div class="banner-greeting">Welcome!</div>
        <pre class="owl">   ,___,
   (O,O)
   /)  )
  --"-"--</pre>
        <div class="banner-info">${escHtml(shortModelName)} · ${escHtml(init.provider)}</div>
      </div>
      <div class="banner-right">
        <div class="banner-section-title">Tips for getting started</div>
        <div class="tip"><span class="tip-cmd">"analyze NVDA"</span> run a deep analysis</div>
        <div class="tip"><span class="tip-cmd">"what is AAPL at?"</span> get a stock quote</div>
        <div class="tip"><span class="tip-cmd">"search TSLA filings"</span> search SEC EDGAR</div>
        <div class="sessions-section">
          <div class="banner-section-title">Recent sessions</div>
          ${sessionsHtml}
        </div>
      </div>
    </div>
  </div>`;

  $messages.insertAdjacentHTML('beforeend', html);

  // Bind session click handlers
  $messages.querySelectorAll('.session-item[data-session-id]').forEach(el => {
    el.addEventListener('click', () => {
      send({ type: 'resume_session', sessionId: el.dataset.sessionId });
    });
  });

  scrollToBottom();
}

function appendUserMessage(id, text) {
  const div = document.createElement('div');
  div.className = 'message user';
  div.id = 'msg-' + id;
  div.innerHTML = `<div class="message-content"><span class="prompt-icon">❯</span>${escHtml(text)}</div>`;
  $messages.appendChild(div);
  scrollToBottom();
}

function startAssistantMessage(id) {
  state.currentAssistantId = id;
  state.streamingText = '';
  state.streamingThinking = '';
  state.thinkingComplete = false;

  const div = document.createElement('div');
  div.className = 'message assistant';
  div.id = 'msg-' + id;
  div.innerHTML = `
    <div class="thinking-container"></div>
    <div class="tool-calls-container"></div>
    <div class="pipeline-container"></div>
    <div class="message-content markdown-content"><span class="streaming-cursor"></span></div>`;
  $messages.appendChild(div);
  scrollToBottom();
}

function appendTextDelta(delta) {
  state.streamingText += delta;
  const el = getCurrentContentEl();
  if (el) {
    el.innerHTML = md.parse(state.streamingText) + '<span class="streaming-cursor"></span>';
    scrollToBottom();
  }
}

function appendReasoningDelta(delta) {
  state.streamingThinking += delta;
  const container = getCurrentThinkingContainer();
  if (!container) return;

  let block = container.querySelector('.thinking-block.streaming');
  if (!block) {
    block = document.createElement('details');
    block.className = 'thinking-block streaming';
    block.open = false;
    block.innerHTML = `<summary>Thinking...</summary><div class="thinking-content"></div>`;
    container.appendChild(block);
  }

  // Show last 4 lines as preview in summary
  const lines = state.streamingThinking.split('\n');
  const lineCount = lines.length;
  const preview = lines.slice(-4).join('\n');
  block.querySelector('summary').textContent = `Thinking... (${lineCount} lines)`;
  block.querySelector('.thinking-content').textContent = state.streamingThinking;
  scrollToBottom();
}

function appendToolCallStart(toolCall) {
  const container = getCurrentToolCallsContainer();
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'tool-call';
  div.id = 'tool-' + toolCall.id;
  div.innerHTML = `<span class="tool-icon running">${SPINNER_FRAMES[spinnerFrame]}</span>
    <span class="tool-name">${escHtml(toolCall.name)}</span>
    <span class="tool-duration"></span>`;
  container.appendChild(div);
  scrollToBottom();
}

function completeToolCall(id, result) {
  const el = document.getElementById('tool-' + id);
  if (!el) return;

  const icon = el.querySelector('.tool-icon');
  icon.className = 'tool-icon done';
  icon.textContent = '✓';
}

function updatePipeline(event, pipelineState) {
  const container = getCurrentPipelineContainer();
  if (!container) return;

  let pipeline = container.querySelector('.pipeline');
  if (!pipeline) {
    pipeline = document.createElement('div');
    pipeline.className = 'pipeline';
    pipeline.innerHTML = `<div class="pipeline-header">
      <span class="pipeline-title">Pipeline</span>
      <span class="pipeline-cost"></span>
    </div><div class="pipeline-stages"></div>`;
    container.appendChild(pipeline);
  }

  // Update stages
  const stagesContainer = pipeline.querySelector('.pipeline-stages');
  stagesContainer.innerHTML = '';
  pipelineState.stages.forEach((stage, idx) => {
    const stageEl = document.createElement('div');
    stageEl.className = 'pipeline-stage';

    let icon = '○';
    let iconClass = 'pending';
    if (stage.status === 'running') { icon = SPINNER_FRAMES[spinnerFrame]; iconClass = 'running'; }
    else if (stage.status === 'done') { icon = '✓'; iconClass = 'done'; }
    else if (stage.status === 'error') { icon = '✗'; iconClass = 'error'; }

    let meta = '';
    if (stage.costUsd != null) meta += `$${stage.costUsd.toFixed(4)}`;
    if (stage.elapsedMs != null) meta += ` ${(stage.elapsedMs / 1000).toFixed(1)}s`;

    let detailsHtml = '';
    // Tool calls within stage
    if (stage.toolCalls && stage.toolCalls.length > 0) {
      const toolsHtml = stage.toolCalls.map(tc => {
        let tcIcon = SPINNER_FRAMES[spinnerFrame];
        let tcClass = 'running';
        if (tc.status === 'done') { tcIcon = '✓'; tcClass = 'done'; }
        else if (tc.status === 'error') { tcIcon = '✗'; tcClass = 'error'; }
        const dur = tc.durationMs ? ` (${(tc.durationMs/1000).toFixed(1)}s)` : '';
        return `<div class="tool-call" style="margin: 2px 0; border: none; background: transparent; padding: 2px 0;">
          <span class="tool-icon ${tcClass}">${tcIcon}</span>
          <span class="tool-name">${escHtml(tc.toolName)}</span>
          <span class="tool-duration">${dur}</span>
        </div>`;
      }).join('');
      detailsHtml += toolsHtml;
    }
    // Stream lines
    if (stage.streamLines && stage.streamLines.length > 0) {
      detailsHtml += `<div style="color: var(--text-dim); font-size: 11px; white-space: pre-wrap; margin-top: 4px;">${escHtml(stage.streamLines.slice(-20).join('\n'))}</div>`;
    }

    let detailsBlock = '';
    if (detailsHtml) {
      detailsBlock = `<details class="pipeline-stage-details"><summary>Details</summary><div class="stage-detail-content">${detailsHtml}</div></details>`;
    }

    stageEl.innerHTML = `<div class="stage-row">
      <span class="stage-icon ${iconClass}">${icon}</span>
      <span class="stage-name">${escHtml(stage.name)}</span>
      <span class="stage-meta">${meta}</span>
    </div>${detailsBlock}`;
    stagesContainer.appendChild(stageEl);
  });

  // Update cost
  const costEl = pipeline.querySelector('.pipeline-cost');
  costEl.textContent = `$${pipelineState.totalCostUsd.toFixed(4)}`;
  costEl.style.color = pipelineState.done ? 'var(--green)' : 'var(--blue)';

  scrollToBottom();
}

function completeAssistantMessage(msg) {
  state.currentAssistantId = null;

  const el = document.getElementById('msg-' + msg.id);
  if (!el) return;

  // Finalize content (remove cursor)
  const contentEl = el.querySelector('.message-content');
  if (contentEl) {
    contentEl.innerHTML = md.parse(msg.content);
  }

  // Finalize thinking block
  const thinkingBlock = el.querySelector('.thinking-block.streaming');
  if (thinkingBlock && msg.thinking) {
    thinkingBlock.classList.remove('streaming');
    const lines = msg.thinking.split('\n').length;
    thinkingBlock.querySelector('summary').textContent = `Thought (${lines} lines)`;
    thinkingBlock.querySelector('.thinking-content').textContent = msg.thinking;
    thinkingBlock.open = false;
  } else if (thinkingBlock && !msg.thinking) {
    thinkingBlock.remove();
  }

  state.streamingText = '';
  state.streamingThinking = '';
  scrollToBottom();
}

function appendRestoredAssistantMessage(msg) {
  const div = document.createElement('div');
  div.className = 'message assistant';
  div.id = 'msg-' + msg.id;

  let thinkingHtml = '';
  if (msg.thinking) {
    const lines = msg.thinking.split('\n').length;
    thinkingHtml = `<details class="thinking-block"><summary>Thought (${lines} lines)</summary><div class="thinking-content">${escHtml(msg.thinking)}</div></details>`;
  }

  let toolsHtml = '';
  if (msg.toolCalls && msg.toolCalls.length > 0) {
    toolsHtml = msg.toolCalls.map(tc => {
      const icon = tc.status === 'done' ? '✓' : tc.status === 'error' ? '✗' : '○';
      const iconClass = tc.status === 'done' ? 'done' : tc.status === 'error' ? 'error' : 'pending';
      return `<div class="tool-call"><span class="tool-icon ${iconClass}">${icon}</span><span class="tool-name">${escHtml(tc.name)}</span></div>`;
    }).join('');
  }

  div.innerHTML = `
    <div class="thinking-container">${thinkingHtml}</div>
    <div class="tool-calls-container">${toolsHtml}</div>
    <div class="pipeline-container"></div>
    <div class="message-content markdown-content">${md.parse(msg.content)}</div>`;
  $messages.appendChild(div);
}

function appendSystemMessage(text) {
  const div = document.createElement('div');
  div.className = 'message system';
  div.innerHTML = `<div class="message-content">${escHtml(text)}</div>`;
  $messages.appendChild(div);
  scrollToBottom();
}

// ── Approval / Permission modals ─────────────────────────────────────
function showApprovalModal(estimate) {
  const stages = estimate.stages ? estimate.stages.map(s =>
    `<div style="margin: 2px 0; font-size: 12px;">• ${escHtml(s.name)} — ${escHtml(s.model)} (~$${s.estimatedCostUsd?.toFixed(4) || '?'})</div>`
  ).join('') : '';

  $modalContainer.innerHTML = `<div class="modal-overlay">
    <div class="modal">
      <h3>Pipeline Approval Required</h3>
      <p><strong>${escHtml(estimate.skillName || 'Pipeline')}</strong></p>
      ${stages}
      <p style="margin-top: 12px;">Estimated cost: <strong style="color: var(--yellow)">$${estimate.totalEstimatedCostUsd?.toFixed(4) || '?'}</strong></p>
      <div class="modal-actions">
        <button class="danger" id="modal-cancel">Cancel</button>
        <button class="primary" id="modal-approve">Approve</button>
      </div>
    </div>
  </div>`;

  document.getElementById('modal-approve').onclick = () => {
    send({ type: 'approval_response', approved: true });
    $modalContainer.innerHTML = '';
  };
  document.getElementById('modal-cancel').onclick = () => {
    send({ type: 'approval_response', approved: false });
    $modalContainer.innerHTML = '';
  };
}

function showPermissionModal(toolName, args) {
  const argsHtml = Object.entries(args).map(([k, v]) =>
    `<div style="font-size: 12px; margin: 2px 0;"><span style="color: var(--cyan)">${escHtml(k)}</span>: ${escHtml(JSON.stringify(v))}</div>`
  ).join('');

  $modalContainer.innerHTML = `<div class="modal-overlay">
    <div class="modal">
      <h3>Tool Permission Required</h3>
      <p>The assistant wants to use: <strong style="color: var(--cyan)">${escHtml(toolName)}</strong></p>
      ${argsHtml}
      <div class="modal-actions">
        <button class="danger" id="modal-cancel">Deny</button>
        <button class="primary" id="modal-approve">Allow</button>
      </div>
    </div>
  </div>`;

  document.getElementById('modal-approve').onclick = () => {
    send({ type: 'approval_response', approved: true });
    $modalContainer.innerHTML = '';
  };
  document.getElementById('modal-cancel').onclick = () => {
    send({ type: 'approval_response', approved: false });
    $modalContainer.innerHTML = '';
  };
}

// ── Cost & processing ────────────────────────────────────────────────
function updateCost(cost, budget) {
  state.sessionCostUsd = cost;
  state.budgetUsd = budget;
  const pct = budget > 0 ? cost / budget : 0;
  $costDisplay.textContent = `$${cost.toFixed(4)} / $${budget.toFixed(2)}`;
  $costDisplay.className = 'cost-display ' + (pct > 0.8 ? 'red' : pct > 0.5 ? 'yellow' : 'green');
}

function setProcessing(isProcessing) {
  state.isProcessing = isProcessing;
  $input.disabled = isProcessing;
  if (!isProcessing) $input.focus();
}

// ── Mode badges ──────────────────────────────────────────────────────
function updateModeBadges() {
  ['plan', 'dry-run', 'read-only'].forEach(mode => {
    const badge = document.getElementById('badge-' + mode);
    badge.classList.toggle('active', state.modes[mode]);
  });
}

['plan', 'dry-run', 'read-only'].forEach(mode => {
  document.getElementById('badge-' + mode).addEventListener('click', () => {
    const newVal = !state.modes[mode];
    state.modes[mode] = newVal;
    updateModeBadges();
    send({ type: 'set_mode', mode, enabled: newVal });
  });
});

// ── Input handling ───────────────────────────────────────────────────
$input.addEventListener('keydown', (e) => {
  // Autocomplete navigation
  if (state.autocompleteVisible) {
    const items = $autocompleteMenu.querySelectorAll('.autocomplete-item');
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      state.autocompleteIndex = Math.max(0, state.autocompleteIndex - 1);
      updateAutocompleteSelection(items);
      return;
    }
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      state.autocompleteIndex = Math.min(items.length - 1, state.autocompleteIndex + 1);
      updateAutocompleteSelection(items);
      return;
    }
    if (e.key === 'Tab' || (e.key === 'Enter' && state.autocompleteIndex >= 0)) {
      e.preventDefault();
      if (state.autocompleteIndex >= 0 && items[state.autocompleteIndex]) {
        const cmd = items[state.autocompleteIndex].dataset.cmd;
        $input.value = cmd + ' ';
        hideAutocomplete();
      }
      return;
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      hideAutocomplete();
      return;
    }
  }

  // Submit message
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const text = $input.value.trim();
    if (!text || state.isProcessing) return;

    // Handle client-side slash commands
    if (text === '/plan') {
      state.modes.plan = !state.modes.plan;
      updateModeBadges();
      send({ type: 'set_mode', mode: 'plan', enabled: state.modes.plan });
      $input.value = '';
      hideAutocomplete();
      return;
    }
    if (text === '/dry-run') {
      state.modes['dry-run'] = !state.modes['dry-run'];
      updateModeBadges();
      send({ type: 'set_mode', mode: 'dry-run', enabled: state.modes['dry-run'] });
      $input.value = '';
      hideAutocomplete();
      return;
    }
    if (text === '/read-only') {
      state.modes['read-only'] = !state.modes['read-only'];
      updateModeBadges();
      send({ type: 'set_mode', mode: 'read-only', enabled: state.modes['read-only'] });
      $input.value = '';
      hideAutocomplete();
      return;
    }

    send({ type: 'send_message', text });
    $input.value = '';
    hideAutocomplete();
  }

  // Abort with Escape
  if (e.key === 'Escape' && state.isProcessing && !state.autocompleteVisible) {
    send({ type: 'abort' });
  }
});

// Autocomplete on input
$input.addEventListener('input', () => {
  const val = $input.value;
  if (val.startsWith('/') && !val.includes(' ')) {
    const prefix = val.toLowerCase();
    const matches = SLASH_COMMANDS.filter(c => c.cmd.startsWith(prefix));
    // Also add skills as slash commands
    const skillMatches = state.skills
      .filter(s => ('/' + s.replace(/-/g, '')).startsWith(prefix) || ('/' + s).startsWith(prefix))
      .map(s => ({ cmd: '/' + s, desc: 'Run skill' }));
    const allMatches = [...matches, ...skillMatches].slice(0, 8);
    if (allMatches.length > 0) {
      showAutocomplete(allMatches);
      return;
    }
  }
  hideAutocomplete();
});

function showAutocomplete(items) {
  state.autocompleteVisible = true;
  state.autocompleteIndex = 0;
  $autocompleteMenu.innerHTML = items.map((item, i) =>
    `<div class="autocomplete-item${i === 0 ? ' selected' : ''}" data-cmd="${escAttr(item.cmd)}">
      <span class="cmd">${escHtml(item.cmd)}</span>
      <span class="desc">${escHtml(item.desc)}</span>
    </div>`
  ).join('');
  $autocompleteMenu.classList.remove('hidden');

  // Click handlers
  $autocompleteMenu.querySelectorAll('.autocomplete-item').forEach(el => {
    el.addEventListener('click', () => {
      $input.value = el.dataset.cmd + ' ';
      hideAutocomplete();
      $input.focus();
    });
  });
}

function hideAutocomplete() {
  state.autocompleteVisible = false;
  state.autocompleteIndex = -1;
  $autocompleteMenu.classList.add('hidden');
}

function updateAutocompleteSelection(items) {
  items.forEach((item, i) => {
    item.classList.toggle('selected', i === state.autocompleteIndex);
  });
}

// ── Helper: current message containers ───────────────────────────────
function getCurrentContentEl() {
  if (!state.currentAssistantId) return null;
  const msg = document.getElementById('msg-' + state.currentAssistantId);
  return msg?.querySelector('.message-content');
}

function getCurrentThinkingContainer() {
  if (!state.currentAssistantId) return null;
  const msg = document.getElementById('msg-' + state.currentAssistantId);
  return msg?.querySelector('.thinking-container');
}

function getCurrentToolCallsContainer() {
  if (!state.currentAssistantId) return null;
  const msg = document.getElementById('msg-' + state.currentAssistantId);
  return msg?.querySelector('.tool-calls-container');
}

function getCurrentPipelineContainer() {
  if (!state.currentAssistantId) return null;
  const msg = document.getElementById('msg-' + state.currentAssistantId);
  return msg?.querySelector('.pipeline-container');
}

// ── Utility functions ────────────────────────────────────────────────
function scrollToBottom() {
  requestAnimationFrame(() => {
    $messages.scrollTop = $messages.scrollHeight;
  });
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escAttr(s) {
  return escHtml(s).replace(/'/g, '&#39;');
}

function shortModel(modelId) {
  if (!modelId) return modelId;
  if (modelId.includes('claude-sonnet-4')) return 'Claude Sonnet 4';
  if (modelId.includes('claude-opus-4')) return 'Claude Opus 4';
  if (modelId.includes('claude-haiku')) return 'Claude Haiku';
  if (modelId.includes('gpt-4o-mini')) return 'GPT-4o Mini';
  if (modelId.includes('gpt-4o')) return 'GPT-4o';
  if (modelId.includes('gemini-2.5-pro')) return 'Gemini 2.5 Pro';
  if (modelId.includes('gemini-2.5-flash')) return 'Gemini 2.5 Flash';
  if (modelId.includes('gemini-2.0-flash')) return 'Gemini 2.0 Flash';
  return modelId;
}

function formatTimeAgo(timestamp) {
  const diff = Date.now() - timestamp;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ago';
  const days = Math.floor(hours / 24);
  return days + 'd ago';
}

// ── Initialize ───────────────────────────────────────────────────────
connect();
$input.focus();

</script>
</body>
</html>
